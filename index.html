<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Audio Visualizer based on Three.js</title>
  <link href="https://fonts.googleapis.com/css?family=Saira" rel="stylesheet">
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <div id="header">
    <h1>MULTIMOD | MrGato y sus putas 2</h1>
  </div>
  <!-- <div id="left">
    <h2>STAFF:</h2>
    <h3>SuperAdmins:</h3>
    <h3>Admins</h3>
            <ul class="name-list"> 
                <li data-steam-id="76561198276290372">Nombre1</li>
                <li data-steam-id="76561198099476831">Nombre2</li>
                <li data-steam-id="76561198083800638">Nombre3</li>
                <li data-steam-id="76561198096611688">Nombre4</li>
            </ul>
    <ul id="superadmin-list"></ul>
    <h3>Admins:</h3>
    <ul id="admin-list"></ul>
  </div>
-->
  <div id="right">
    <h2>DISCORD OFICIAL:</h2>
    <h3><a href="https://discord.gg/49BxqscV" target="_blank">https://discord.gg/49BxqscV</a></h3>
  </div>
  <div id="content">
    <label for="thefile" class="file" style="display: none;"> Choose an audio file
      <input type="file" id="thefile" accept="audio/*" style="display: none;" />
    </label>
    <select id="preloaded-audio" style="display: none;">
      <option value="">Select a song</option>
      <option value="audio/donki.mp3">Song 1</option>
      <option value="audio/kaskade.mp3">Song 2</option>
      <option value="audio/twofriends.mp3">Song 3</option>
    </select>
    <audio id="audio" controls style="display: none;"></audio>
    <div id="out"></div>
  </div>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/three.js/84/three.min.js'></script>
  <script src='https://cdn.rawgit.com/mrdoob/three.js/master/examples/js/controls/OrbitControls.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.3/dat.gui.min.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/simplex-noise/2.3.0/simplex-noise.min.js'></script>
  <script src="./script.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
        const file = document.getElementById('thefile');
        const audio = document.getElementById('audio');
        const preloadedAudio = document.getElementById('preloaded-audio');
        const fileLabel = document.querySelector("label.file");

        function getRandomSong() {
            const options = Array.from(preloadedAudio.options);
            const validOptions = options.filter(option => option.value !== "");
            const randomIndex = Math.floor(Math.random() * validOptions.length);
            return validOptions[randomIndex].value;
        }

        function playAudio(src) {
            audio.src = src;
            audio.load();
            audio.play();
            play();
        }

        // Reproduce una canción aleatoria al cargar la página
        window.addEventListener('load', () => {
            const randomSong = getRandomSong();
            if (randomSong) {
                playAudio(randomSong);
            }
        });

        file.onchange = function() {
            const files = this.files;
            if (files.length > 0) {
                fileLabel.classList.add('normal');
                audio.classList.add('active');
                playAudio(URL.createObjectURL(files[0]));
            }
        };

        preloadedAudio.onchange = function() {
            const selectedValue = this.value;
            if (selectedValue) {
                playAudio(selectedValue);
            }
        };

        function play() {
            var context = new AudioContext();
            var src = context.createMediaElementSource(audio);
            var analyser = context.createAnalyser();
            src.connect(analyser);
            analyser.connect(context.destination);
            analyser.fftSize = 512;
            var bufferLength = analyser.frequencyBinCount;
            var dataArray = new Uint8Array(bufferLength);
            var scene = new THREE.Scene();
            var group = new THREE.Group();
            var camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 0, 100);
            camera.lookAt(scene.position);
            scene.add(camera);

            var renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);

            var planeGeometry = new THREE.PlaneGeometry(800, 800, 20, 20);
            var planeMaterial = new THREE.MeshLambertMaterial({
                color: 0x6904ce,
                side: THREE.DoubleSide,
                wireframe: true
            });

            var plane = new THREE.Mesh(planeGeometry, planeMaterial);
            plane.rotation.x = -0.5 * Math.PI;
            plane.position.set(0, 30, 0);
            group.add(plane);

            var plane2 = new THREE.Mesh(planeGeometry, planeMaterial);
            plane2.rotation.x = -0.5 * Math.PI;
            plane2.position.set(0, -30, 0);
            group.add(plane2);

            var icosahedronGeometry = new THREE.IcosahedronGeometry(10, 4);
            var lambertMaterial = new THREE.MeshLambertMaterial({
                color: 0xff00ee,
                wireframe: true
            });

            var ball = new THREE.Mesh(icosahedronGeometry, lambertMaterial);
            ball.position.set(0, 0, 0);
            group.add(ball);

            var ambientLight = new THREE.AmbientLight(0xaaaaaa);
            scene.add(ambientLight);

            var spotLight = new THREE.SpotLight(0xffffff);
            spotLight.intensity = 0.9;
            spotLight.position.set(-10, 40, 20);
            spotLight.lookAt(ball);
            spotLight.castShadow = true;
            scene.add(spotLight);

            scene.add(group);

            document.getElementById('out').appendChild(renderer.domElement);

            window.addEventListener('resize', onWindowResize, false);

            render();

            function render() {
                analyser.getByteFrequencyData(dataArray);

                var lowerHalfArray = dataArray.slice(0, (dataArray.length / 2) - 1);
                var upperHalfArray = dataArray.slice((dataArray.length / 2) - 1, dataArray.length - 1);

                var overallAvg = avg(dataArray);
                var lowerMax = max(lowerHalfArray);
                var lowerAvg = avg(lowerHalfArray);
                var upperMax = max(upperHalfArray);
                var upperAvg = avg(upperHalfArray);

                var lowerMaxFr = lowerMax / lowerHalfArray.length;
                var lowerAvgFr = lowerAvg / lowerHalfArray.length;
                var upperMaxFr = upperMax / upperHalfArray.length;
                var upperAvgFr = upperAvg / upperHalfArray.length;

                makeRoughGround(plane, modulate(upperAvgFr, 0, 1, 0.5, 4));
                makeRoughGround(plane2, modulate(lowerMaxFr, 0, 1, 0.5, 4));

                makeRoughBall(ball, modulate(Math.pow(lowerMaxFr, 0.8), 0, 1, 0, 8), modulate(upperAvgFr, 0, 1, 0, 4));

                group.rotation.y += 0.005;
                renderer.render(scene, camera);
                requestAnimationFrame(render);
            }

            function onWindowResize() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }

            function makeRoughBall(mesh, bassFr, treFr) {
                mesh.geometry.vertices.forEach(function(vertex) {
                    var offset = mesh.geometry.parameters.radius;
                    var amp = 7;
                    var time = window.performance.now();
                    vertex.normalize();
                    var rf = 0.00001;
                    var distance = (offset + bassFr) + noise.noise3D(vertex.x + time * rf * 7, vertex.y + time * rf * 8, vertex.z + time * rf * 9) * amp * treFr;
                    vertex.multiplyScalar(distance);
                });
                mesh.geometry.verticesNeedUpdate = true;
                mesh.geometry.normalsNeedUpdate = true;
                mesh.geometry.computeVertexNormals();
                mesh.geometry.computeFaceNormals();
            }

            function makeRoughGround(mesh, distortionFr) {
                mesh.geometry.vertices.forEach(function(vertex) {
                    var amp = 2;
                    var time = Date.now();
                    var distance = (noise.noise2D(vertex.x + time * 0.0003, vertex.y + time * 0.0001) + 0) * distortionFr * amp;
                    vertex.z = distance;
                });
                mesh.geometry.verticesNeedUpdate = true;
                mesh.geometry.normalsNeedUpdate = true;
                mesh.geometry.computeVertexNormals();
                mesh.geometry.computeFaceNormals();
            }

            function fractionate(val, minVal, maxVal) {
                return (val - minVal) / (maxVal - minVal);
            }

            function modulate(val, minVal, maxVal, outMin, outMax) {
                var fr = fractionate(val, minVal, maxVal);
                var delta = outMax - outMin;
                return outMin + (fr * delta);
            }

            function avg(arr) {
                var total = arr.reduce(function(sum, b) {
                    return sum + b;
                });
                return (total / arr.length);
            }

            function max(arr) {
                return arr.reduce(function(a, b) {
                    return Math.max(a, b);
                });
            }

            audio.play();
        }

        vizInit();
    });
  </script>
</body>
</html>
